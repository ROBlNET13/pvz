name: Deploy

on:
    push:
      branches:
        - main
    workflow_dispatch:

permissions:
    contents: write
    deployments: write

concurrency:
  group: "cloudflare-pages"
  cancel-in-progress: false

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        env:
            PNPM_HOME: /home/runner/.local/share/pnpm
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 1

            - name: Setup Node.js & pnpm
              uses: actions/setup-node@v3
              with:
                  node-version: "lts/*"

            - name: Install pnpm
              run: |
                  corepack enable pnpm
                  mkdir -p "$PNPM_HOME"
                  echo "$PNPM_HOME" >> "$GITHUB_PATH"

            - name: Cache pnpm global packages
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.local/share/pnpm/global
                      ~/.local/share/pnpm/store
                  key: pnpm-global-${{ hashFiles('.github/workflows/deploy.yml') }}
                  restore-keys: pnpm-global-

            - name: Install dependencies
              run: pnpm add -g oxlint oxfmt esbuild html-minifier-terser wrangler

            - name: Lint, format & version stamp
              run: |
                  pnpm run fix || true
                  pnpm oxfmt --write . "**/*.{js,md,html,css,yml}"
                  echo "${{ github.sha }}" > game/images/Zombies/CX/v.html

            - name: Commit changes
              run: |
                  COMMIT_MSG=$(git log -1 --pretty=format:%s)
                  AUTHOR_EMAIL=$(git log -1 --pretty=format:%ae)
                  git config user.name github-actions
                  git config user.email github-actions@github.com
                  git add .
                  git commit -m "Format \"$COMMIT_MSG\"
                  Original commit: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
                  
                  Co-authored-by: ${{ github.actor }} <$AUTHOR_EMAIL>" || exit 0
                  git push

            - name: Bundle & minify all assets
              run: |
                  esbuild game/js/CPlants.js \
                    --bundle --minify --sourcemap --sources-content=true \
                    --outfile=game/js/CPlants.js --allow-overwrite

                  esbuild $(find . -type f \( -name "*.js" -o -name "*.css" \) \
                    -not -path "./node_modules/*" -not -name "CPlants.js") \
                    --minify --sourcemap --sources-content=true \
                    --outdir=. --allow-overwrite &

                  find . -type f -name "*.html" -not -path "./node_modules/*" | \
                    xargs -P4 -I{} html-minifier-terser \
                      --collapse-whitespace --remove-comments --remove-tag-whitespace \
                      --minify-css true --minify-js true -o {} {} &

                  wait

            - name: Deploy to Cloudflare Pages
              run: wrangler pages deploy . --project-name=pvz --commit-dirty=true
              env:
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
